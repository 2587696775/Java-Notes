## UDP和TCP的区别

**UDP**：在传送数据前不需要建立连接，远端的主机在收到UDP报文后也不需要给出任何确认。虽然UDP不提供可靠交付，正因为这样，省去很多的开销，使它的传输速度比较快，比如一些对实时性要求较高的服务，就常用的是UDP。对应的应用层的协议主要有：DNS、TFTP、DHCP、SNMP、NPS等。

**TCP**：提供面向连接的服务，在传送数据前必须先建立连接，数据传送完成后要释放连接。因此TCP是一种可靠的传输服务，因为这样，不可避免的增加了许多开销，比如确认、流量控制等。对应的应用层的协议主要有SMTP、TELENT、HTTP、FTP等。

## 套接字

TCP把连接作为最基本的对象，每一条TCP连接都有两个端点，这种断点我们叫作套接字（socket），它的定义为端口号拼接到IP地址即构成了套接字，例如，若IP地址为192.3.4.16 而端口号为80，那么得到的套接字为192.3.4.16:80。

## TCP连接的建立（三次握手）

![image-20210316195845018](F:\编程教程\个人笔记\图片\计算机网络\三次握手.png)

**最开始的时候客户端和服务器都是处于CLOSED状态。主动打开连接的为客户端，被动打开连接的是服务器。**

1.  TCP服务器进程先创建传输控制块TCB，时刻准备接收客户端的连接请求，此时服务器处于LISTEN（监听）状态。

2.  TCP客户端也是先创建传输控制块TCB，然后向服务器发送连接请求报文，报文首部同部位SYN=1，同时初始化一个序列号seq=x，此时客户端进入了SYN-SENT(同步已发送状态)。

    *TCP规定，SYN报文段（SYN=1的报文段）不能携带数据，但需要消耗掉一个序号*

3.  服务器接收到请求后，如果同意连接，则发出确认报文。确认报文中ACK=1，SYN=1，确认号是ack=x+1，同时也要为自己初始化一个序列号seq=y，此时服务器进入了SYN-RCVD(同步收到)状态。

    *这个报文也不能携带数据，同样消耗掉一个序号*

4.  客户端收到服务器的确认之后，还要向服务器给出确认。确认报文的ACK=1，ack=y+1，自己的序列号seq=x+1，此时TCP连接建立，客户端进入ESTABLISHED（已建立连接）状态。

    *TCP规定，ACK报文段可以携带数据，但是如果不携带数据则不消耗序号。*

5.  当服务器收到客户端的确认后也进入ESTABLISHED状态，此后双方就可以开始通信了。

*位码即tcp标志位，有6种标示：SYN(synchronous建立联机) ACK(acknowledgement 确认) PSH(push传送) FIN(finish结束) RST(reset重置) URG(urgent紧急)Sequence number(顺序号码) Acknowledge number(确认号码)*

## 为什么TCP客户端最后还要发送一次确认呢？

一句话，**主要防止已经失效的连接请求报文突然又传送到了服务器，从而产生错误。**

如果使用的是两次握手建立连接，假设有这样一种场景，客户端发送了第一个请求连接并且没有丢失，只是因为在网络结点中滞留的时间太长了，由于TCP的客户端迟迟没有收到确认报文，以为服务器没有收到，此时重新向服务器发送这条报文，此后客户端和服务器经过两次握手完成连接，传输数据，然后关闭连接。此时此前滞留的那一次请求连接，网络通畅了到达了服务器，这个报文本该是失效的，但是，两次握手的机制将会让客户端和服务器再次建立连接，这将导致不必要的错误和资源的浪费。

如果采用的是三次握手，就算是那一次失效的报文传送过来了，服务端接受到了那条失效报文并且回复了确认报文，但是客户端不会再次发出确认。由于服务器收不到确认，就知道客户端并没有请求连接。

## TCP连接的释放（四次挥手）

